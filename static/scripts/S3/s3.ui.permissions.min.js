/*
 2018-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var g=0;return function(){return g<a.length?{done:!1,value:a[g++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,g,c){if(a==Array.prototype||a==Object.prototype)return a;a[g]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var g=0;g<a.length;++g){var c=a[g];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,g){var c=$jscomp.propertyToPolyfillSymbol[g];if(null==c)return a[g];c=a[c];return void 0!==c?c:a[g]};
$jscomp.polyfill=function(a,g,c,k){g&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,g,c,k):$jscomp.polyfillUnisolated(a,g,c,k))};$jscomp.polyfillUnisolated=function(a,g,c,k){c=$jscomp.global;a=a.split(".");for(k=0;k<a.length-1;k++){var l=a[k];l in c||(c[l]={});c=c[l]}a=a[a.length-1];k=c[a];g=g(k);g!=k&&null!=g&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:g})};
$jscomp.polyfillIsolated=function(a,g,c,k){var l=a.split(".");a=1===l.length;k=l[0];k=!a&&k in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var b=0;b<l.length-1;b++){var d=l[b];d in k||(k[d]={});k=k[d]}l=l[l.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?k[l]:null;g=g(c);null!=g&&(a?$jscomp.defineProperty($jscomp.polyfills,l,{configurable:!0,writable:!0,value:g}):g!==c&&($jscomp.propertyToPolyfillSymbol[l]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(l):$jscomp.POLYFILL_PREFIX+l,l=$jscomp.propertyToPolyfillSymbol[l],
$jscomp.defineProperty(k,l,{configurable:!0,writable:!0,value:g})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var g=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};g.prototype.toString=function(){return this.$jscomp$symbol$id_};var c=0,k=function(a){if(this instanceof k)throw new TypeError("Symbol is not a constructor");return new g("jscomp_symbol_"+(a||"")+"_"+c++,a)};return k},"es6","es3");$jscomp.initSymbolIterator=function(){};
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var g="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<g.length;c++){var k=$jscomp.global[g[c]];"function"===typeof k&&"function"!=typeof k.prototype[a]&&$jscomp.defineProperty(k.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.initSymbolAsyncIterator=function(){};$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,g){a instanceof String&&(a+="");var c=0,k={next:function(){if(c<a.length){var l=c++;return{value:g(l,a[l]),done:!1}}k.next=function(){return{done:!0,value:void 0}};return k.next()}};k[Symbol.iterator]=function(){return k};return k};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
(function(a,g){var c={rm_Add:"Add",rm_AddRule:"Add Rule",rm_AllEntities:"All Entities",rm_AllRecords:"All Records",rm_AssignedEntities:"Assigned Entities",rm_Cancel:"Cancel",rm_CollapseAll:"Collapse All",rm_ConfirmDeleteRule:"Do you want to delete this rule?",rm_Default:"default",rm_DeleteRule:"Delete",rm_ExpandAll:"Expand All",rm_NoAccess:"No access",rm_NoRestrictions:"No restrictions",rm_Others:"Others",rm_OwnedRecords:"Owned Records",rm_Page:"Page",rm_RestrictedTables:"Restricted Tables",rm_Scope:"Scope",
rm_SystemTables:"System Tables",rm_Table:"Table",rm_UnrestrictedTables:"Unrestricted Tables"},k=function(a){var b,e=a[3];e?!0!==e&&(b=e):!0!==a[2]&&(b=a[1]+"/"+(a[2]||"*"));return b},l=0;a.widget("s3.permissionEdit",{options:{fRules:!1,tRules:!1,useRealms:!1,permissions:[{l:"CREATE",b:1,o:!1},{l:"READ",b:2,o:!0},{l:"UPDATE",b:4,o:!0},{l:"DELETE",b:8,o:!0}],modules:{},models:{},defaultPermissions:{},icons:{expanded:"fa fa-caret-down",collapsed:"fa fa-caret-right"}},_create:function(){this.id=l;l+=
1;this.eventNamespace=".permissionEdit"},_init:function(){var b=a(this.element).attr("id");this.input=a("#"+b+"-input");this.tableWidth=this.options.useRealms?5:4;for(var d in c)c[d]=i18n[d]||c[d];this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var b=a(this.element),d=this.options;this._unbindEvents();this._deserialize();var e=this._ruleSets(),h=a(".rm-rules",b).first(),f=this,c=e.pages,n=a(".rm-page-rules",b);this._renderExpandCollapseAll().appendTo(n);
Object.keys(d.modules).sort().forEach(function(a){d.modules[a][1]&&f._ruleTable("p",a,c[a]).appendTo(n)});c._other.length&&this._ruleTable("p","_other",c._other).appendTo(n);d.tRules&&(c=e.tables,n=a(".rm-table-rules",b),this._renderExpandCollapseAll().appendTo(n),Object.keys(d.models).sort().forEach(function(a){"_system"!=a&&f._ruleTable("t",a,c[a]).appendTo(n)}),this._ruleTable("t","_system",c._system).appendTo(n),c._other.length&&this._ruleTable("t","_other",c._other).appendTo(n));h.tabs().removeClass("hide").show();
this._bindEvents()},_deserialize:function(){try{this.rules=JSON.parse(this.input.val())}catch(b){this.rules=[],this._serialize()}},_serialize:function(){var a=this.rules.filter(function(a){return null!==a[0]&&(0!==a[0]||!a[7])});this.input.val(JSON.stringify(a)).change()},_ruleSets:function(){var a={_other:[]},d={_other:[]},e=this.options;this.rules.forEach(function(b){var f;if(f=b[3]){var h=d;var c=e.models;f=f.split("_")[0]}else{h=a;c=e.modules;f=b[1];var m=b[2];f="default"!=f||"table"!=m&&"tables"!=
m?f:"default/dt"}c.hasOwnProperty(f)?h[f]===g&&(h[f]=[]):f="_other";h[f].push(b)});return{pages:a,tables:d}},_renderExpandCollapseAll:function(){var b=a('<span class="action-lnk rm-expand-all">'),d=a('<span class="action-lnk rm-collapse-all">');b.text(c.rm_ExpandAll);d.text(c.rm_CollapseAll);return a('<div class="rm-toggle-all">').append(b).append(d)},_ruleTable:function(b,d,e){e||(e=[]);var h=a('<table class="rm-module-rules">').data({module:d});h.append(this._ruleTableHeader(d)).append(this._ruleTableBody(b,
d,e)).append(this._ruleTableFooter(b,d,e));this._indicateNumRules(h,e.length);return h},_ruleTableHeader:function(b){var d=a('<thead class="rm-module-header">'),e=a("<th>").attr("colspan",this.tableWidth),h=this.options.icons;if(h){var f=a('<i class="'+h.expanded+'">').hide();h=a('<i class="'+h.collapsed+'">');a('<div class="rm-module-toggle">').append(f).append(h).appendTo(e)}switch(b){case "_system":f="SYSTEM";b=c.rm_SystemTables;break;case "_other":f="*";b=c.rm_Others;break;case "s3dt":f="S3DT";
b=c.rm_DynamicTables;break;default:f="default/dt"==b?"DEFAULT":b.toLocaleUpperCase(),b=this.options.modules.hasOwnProperty(b)?this.options.modules[b][0]:""}a('<div class="rm-module-prefix">').text(f).appendTo(e);a('<div class="rm-module-title">').text(b).appendTo(e);a('<div class="rm-module-numrules">').appendTo(e);a("<tr>").append(e).appendTo(d);return d},_ruleTableBody:function(b,d,e){var h=this.options,f=a("<tbody>").hide(),g=!0,n=e.map(k);if("t"==b){if(d=h.models[d])for(var m in d)d[m]&&-1==n.indexOf(m)&&
e.push([null,null,null,m,null,null,null,!1]);n=c.rm_Table;0===e.length&&(g=!1,f.append(this._defaultRule(!1)))}else{m="default/dt"==d;var l;for(l in h.defaultPermissions)if((b=m?"default/tables"==l||"default/table"==l:l.slice(0,d.length+1)==d+"/")&&-1==n.indexOf(l)){b=l.split("/");var q=b[1];if("*"==q)q=null;else if(!h.fRules)continue;e.push([null,b[0],q,null,null,null,null,!1])}n=c.rm_Page;0===e.length&&(g=!1,f.append(this._defaultRule(!0)))}d=a('<tr class="rm-rule-labels">').hide().appendTo(f);
d.append("<th>"+n+"</th>").append("<th>"+c.rm_AllRecords+"</th>").append("<th>"+c.rm_OwnedRecords+"</th>");h.useRealms&&a("<th>").text(c.rm_Scope).appendTo(d);d.append("<th></th>");if(g){d.show();e=e.sort(function(a,b){a=a.slice(1,4).join(" ");b=b.slice(1,4).join(" ");return a===b?0:a>b&&1||-1});var p=this;e.forEach(function(a){p._ruleTableRow(a).appendTo(f)})}return f},_ruleTableFooter:function(b,d,e){var h=a("<tfoot>").hide();if("_other"!=d){d=a('<tr class="rm-module-add">');var f=a("<td>").attr("colspan",
this.tableWidth);a('<span class="action-lnk rm-add-rule">').text(c.rm_AddRule).appendTo(f);"t"!=b&&!this.options.fRules&&e.length&&d.hide();d.append(f).appendTo(h)}return h},_ruleTableRow:function(b){var d=a('<tr class="rm-rule">').data({rule:b}),e=this.options,h=k(b);if(h)a('<td class="rm-rule-target">').text(h).appendTo(d);else{var f=this._targetSelector(b);a('<td class="rm-rule-target">').append(f).appendTo(d)}h&&null===b[0]?(d.addClass("rm-default-permissions"),b=this._defaultPermissions(h),b.oACL?
(a("<td>").text(b.uACL).appendTo(d),a("<td>").text(b.oACL).appendTo(d)):a("<td>").attr("colspan",2).text(b.uACL).appendTo(d),e.useRealms&&a("<td>").appendTo(d),e=a('<a class="rm-add-rule action-lnk">'),a("<td>").append(e.text(c.rm_AddRule)).appendTo(d)):(f=this._permissionSelector(b),d.append(f.uACL).append(f.oACL),e.useRealms&&a("<td>").append(this._scopeSelector(b)).appendTo(d),h?(e=a('<a class="rm-delete-rule delete-btn-ajax">'),a("<td>").append(e.text(c.rm_DeleteRule)).appendTo(d)):(e=a('<a class="rm-submit-rule action-btn">'),
b=a('<span class="rm-cancel-add action-lnk">'),a("<td>").append(e.text(c.rm_Add)).append(b.text(c.rm_Cancel)).appendTo(d)));return d},_targetSelector:function(b){var d=this.options,e=a("<div>"),h=b[1],f=function(b,d){d===g&&(d=b);return a('<option value="'+b+'">').text(d)},k=function(){return a('<option value="">').prop("selected",!0).prop("disabled",!0).hide()};if(b[3]){var n=d.models[h],m=a("<optgroup>").attr("label",c.rm_RestrictedTables),l=a("<optgroup>").attr("label",c.rm_UnrestrictedTables),
q=0,p=0;Object.keys(n).sort().forEach(function(a){n[a]?(q+=1,m.append(f(a))):(p+=1,l.append(f(a)))});b=a("<select>").append(k());q&&b.append(m);p&&b.append(l)}else"_other"==h?(b=a('<input type="text" size="20">'),b.data("pattern",/^(\w+)(\/(\*|[\w]+))?$/)):"default/dt"==h?(b=a("<select>"),b.append(k()).append(f("default/table")).append(f("default/tables"))):(e.append("<span>"+h+" / </span>"),b=a('<input type="text" size="10">'),b.data("pattern",/^(\w+|\*)$/));b.addClass("rm-target-select").appendTo(e);
return e},_validateTarget:function(a){var b=a.val(),e=a.data("pattern");e.lastIndex=0;if(b&&e&&!e.exec(b))return a.addClass("rm-invalid"),!1;a.removeClass("rm-invalid");return!0},_defaultPermissions:function(a){var b=this.options,e=b.defaultPermissions[a];a={};var h=" ("+c.rm_Default+")";if(e!==g){var f=e[0];e=e[1]&~f;var k=function(a){var d=[];b.permissions.forEach(function(b){a&b.b&&d.push(b.l)});return d.join(", ")};f&&(a.uACL=k(f)+h);e&&(a.oACL=k(e)+h)}a.uACL||(a.uACL=c.rm_NoAccess+h);return a},
_defaultRule:function(b){b=b?c.rm_NoAccess:c.rm_NoRestrictions;b=a("<td>").attr("colspan",this.tableWidth).text(b);return a('<tr class="rm-default-rule">').append(b)},_permissionSelector:function(b){var d=a('<td class="rm-permission-all">'),e=a('<td class="rm-permission-own">');this.options.permissions.forEach(function(h){var f=a('<input class="rm-permission" type="checkbox">'),c=a('<input class="rm-permission" type="checkbox">');a("<label>").append(f).append(h.l).appendTo(d);a("<label>").append(c).append(h.l).css({visibility:h.o&&
"visible"||"hidden"}).appendTo(e);var g=b[5]&h.b;c.prop("checked",g);c.data({bit:h.b,selected:g,implied:!1});g=b[4]&h.b;f.prop("checked",g);f.data({bit:h.b,selected:g,implied:!1});c.data("implied",g);g&&c.prop({checked:!0,disabled:!0});f.data("imply",c)});return{uACL:d,oACL:e}},_scopeSelector:function(b){var d=a('<select class="rm-scope-select">'),e=a('<option value="">').text(c.rm_AssignedEntities),h=a('<option value="any">').text(c.rm_AllEntities);if(b)switch(b[6]){case "any":h.prop("selected",
!0);break;default:e.prop("selected",!0),b[6]=null}d.append(e).append(h);return a("<div>").append(d)},_addRule:function(b){var d=this.options,e=b.closest(".rm-module-rules"),h=e.data("module"),c=d.models[h],g=this;a("tfoot .rm-rule",a(this.element)).each(function(){g._cancelAdd(a(this))});var n=b.closest(".rm-rule");if(n.length){var m=n.data("rule");m=(b=m[3])?[0,null,null,b,0,0,null,!1]:[0,m[1],m[2],null,0,0,null,!1];if(d=d.defaultPermissions[k(m)])m[4]=d[0],m[5]=d[1];this.rules.push(m);m=this._ruleTableRow(m);
n.after(m).remove();b&&(c[b]+=1);this._serialize()}else c=!0,b.closest(".rm-table-rules").length?m=[0,h,null,!0,0,0,null,!1]:d.fRules?m=[0,h,!0,null,0,0,null,!1]:a("tbody .rm-rule",e).length||(m=[0,h,null,null,0,0,null,!1],c=!1),m&&(m=this._ruleTableRow(m),c?b.closest(".rm-module-add").hide().after(m):(a("tbody",e).append(m),b.closest(".rm-module-add").hide())),a(".rm-default-rule",e).hide(),a(".rm-rule-labels",e).show()},_submitAdd:function(b){var d=b.closest(".rm-module-rules"),e=b.data("rule"),
c=null,f=null,k=null,n=a(".rm-target-select",b).val().replace(/\s/,"");if(e[3]){if(k=n,!k)return}else{c=e[1];f=n;var m="_other"==c;if("default/dt"==c||m){if(n=/^(\w+)(\/(\*|[\w]+))?$/.exec(n))c=n[1],f=n[3];else return;if(m)for(m=a(".rm-module-rules",b.closest(".rm-page-rules")),n=m.length;n--;){var l=a(m[n]);if(l.data("module")==c){d=l;break}}}if(!f||"*"==f)f=null;else if(!/^\w+$/.exec(f))return}e[1]=c&&c.toLowerCase();e[2]=f&&f.toLowerCase();e[3]=k&&k.toLowerCase();var q,p,r;a("tbody .rm-rule",d).each(function(){var b=
a(this),d=b.data("rule");if(!q){a:{var c=null===e[0]||null===d[0]?[1,2,3]:[1,2,3,6];for(var h=c.length,g;h--;)if(g=c[h],e[g]!==d[g]){c=!1;break a}c=!0}c?(p=d,r=q=b):r||(k?d[3]>k&&(r=b):d[2]&&(f&&d[2]>f||!f)&&(r=b))}});if(p&&null!==p[0])p.splice(1,e.length-1),p.push.apply(p,e.slice(1)),e=p;else if(this.rules.push(e),c=e[3])m=this.options.models[d.data("module")],m[c]=m[c]!==g?m[c]+1:1;this._serialize();c=this._ruleTableRow(e);r?c.insertBefore(r):c.appendTo(a("tbody",d));q&&q.remove();this._indicateNumRules(d,
a("tbody .rm-rule",d).length);b.siblings(".rm-module-add").show();b.remove()},_cancelAdd:function(b){var d=b.closest(".rm-module-rules");0===a("tbody .rm-rule",d).length&&(a(".rm-rule-labels",d).hide(),a(".rm-default-rule",d).show());b.siblings(".rm-module-add").show();b.remove()},_updateRule:function(a,d){if(a=a.data("rule")){for(var b in d){var c=d[b];if(c!==g)switch(b){case "c":a[1]=c;break;case "f":a[2]=c;break;case "t":a[3]=c;break;case "uACL":a[4]=c;break;case "oACL":a[5]=c;break;case "scope":a[6]=
c;break;case "deleted":a[7]=!!c}}this._serialize()}},_deleteRule:function(b){if(confirm(c.rm_ConfirmDeleteRule)){var d=this.options,e=b.closest(".rm-module-rules"),h=!1,f=b.data("rule");f[7]=!0;this._serialize();var g=f[3];if(g){var l=this.rules.filter(function(a){return a[3]==g&&!a[7]});l.length||(l=e.data("module"),d=d.models[l],--d[g],0<d[g]&&(d=[null,null,null,g,null,null,null,!1],this._ruleTableRow(d).insertBefore(b)))}else l=this.rules.filter(function(a){return a[1]==f[1]&&a[2]==f[2]&&!a[7]}),
!l.length&&d.defaultPermissions[k(f)]&&(d=[null,f[1],f[2],null,null,null,null,!1],this._ruleTableRow(d).insertBefore(b)),h=!0;d=a(".rm-rule",e).length-1;d||(this._defaultRule(h).insertBefore(b),a(".rm-rule-labels",e).hide(),a(".rm-module-add",e).show());this._indicateNumRules(e,d);b.remove()}},_updatePermissions:function(b){this._updateRule(b,{uACL:this._getPermissions(a(".rm-permission-all",b)),oACL:this._getPermissions(a(".rm-permission-own",b))})},_getPermissions:function(b){var d=0;a(".rm-permission",
b).each(function(){var b=a(this);!b.data("implied")&&b.data("selected")&&(b=b.data("bit"))&&(d|=b)});return d},_indicateNumRules:function(b,d){var c=a(".rm-module-numrules",b);d?(c.text("["+d+"]"),b.addClass("hasrules")):(c.empty(),b.removeClass("hasrules"))},_toggleRuleTable:function(b){b.hasClass("rm-expanded")?(a("tbody, tfoot",b).hide(),b.removeClass("rm-expanded")):(a("tbody, tfoot",b).show(),b.addClass("rm-expanded"));a(".rm-module-toggle i",b).toggle()},_toggleAll:function(b,d){var c=this;
d?a(".rm-module-rules:not(.rm-expanded)",b).each(function(b,d){c._toggleRuleTable(a(d))}):a(".rm-module-rules.rm-expanded",b).each(function(b,d){c._toggleRuleTable(a(d))})},_permissionChanged:function(a){if(a.data("implied"))a.prop({checked:!0,disabled:!0});else if(a.prop("disabled"))a.prop({disabled:!1,checked:a.data("selected")});else{var b=a.prop("checked"),c=a.data("imply");a.data({selected:b});c&&c.length&&c.data("implied",b).change()}this._updatePermissions(a.closest(".rm-rule"))},_scopeChanged:function(a){var b=
a.closest(".rm-rule").data("rule");switch(a.val()){case "any":b[6]="any";break;default:b[6]=null}this._serialize()},_bindEvents:function(){var b=a(this.element),d=this.eventNamespace,c=this;a(".rm-table-rules, .rm-page-rules",b).on("click"+d,".rm-expand-all",function(){c._toggleAll(a(this).closest(".rm-table-rules, .rm-page-rules"),!0);return!1}).on("click"+d,".rm-collapse-all",function(){c._toggleAll(a(this).closest(".rm-table-rules, .rm-page-rules"),!1);return!1});a(".rm-module-rules",b).on("click"+
d,".rm-module-header",function(){c._toggleRuleTable(a(this).closest(".rm-module-rules"));return!1}).on("change"+d,".rm-permission",function(){c._permissionChanged(a(this));return!1}).on("change"+d,".rm-scope-select",function(){c._scopeChanged(a(this));return!1}).on("click"+d,".rm-delete-rule",function(){c._deleteRule(a(this).closest(".rm-rule"));return!1}).on("click"+d,".rm-add-rule",function(){c._addRule(a(this))}).on("click"+d,".rm-cancel-add",function(){c._cancelAdd(a(this).closest(".rm-rule"))}).on("click"+
d,".rm-submit-rule",function(){c._submitAdd(a(this).closest(".rm-rule"))}).on("input"+d,"input.rm-target-select",function(){c._validateTarget(a(this))});return!0},_unbindEvents:function(){var b=a(this.element),c=this.eventNamespace;a(".rm-module-rules, .rm-table-rules, .rm-page-rules",b).off(c);return!0}})})(jQuery);
