/*
 2013-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,k,f){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var d=b[c];if(k.call(f,d,c,b))return{i:c,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,k,f){b!=Array.prototype&&b!=Object.prototype&&(b[k]=f.value)};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var k=0;k<b.length;++k){var f=b[k];if(f&&f.Math==Math)return f}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,k,f,a){if(k){f=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];c in f||(f[c]={});f=f[c]}b=b[b.length-1];a=f[b];k=k(a);k!=a&&null!=k&&$jscomp.defineProperty(f,b,{configurable:!0,writable:!0,value:k})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,f){return $jscomp.findInternal(this,b,f).v}},"es6","es3");
(function(b,k){var f=0;b.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,defaultChartType:"linechart",defaultChartAxis:"totals"},_create:function(){this.id=f;f+=1},_init:function(){var a=b(this.element),c=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():
null;this.currentChart={type:null,chart:null,container:null};c.numberFormatter=function(a){var b=c.precision;if(null===a||"undefined"==typeof a)return"-";b=b||0==b?a.toFixed(b):a.toString();b=b.split(".");a=b[0];b=1<b.length?"."+b[1]:"";a=a.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return a+b};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=
null;b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?a.find(".tp-submit").hide():a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=b(this.element),c=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var d=a.attr("id");a=b('<div class="pt-chart-opts">');var g=d+"-bchart-totals";d+="-lchart-totals";b(a).append(b('<span id="'+
d+'" class="tp-chart-icon tp-lchart"/><span class="tp-chart-label">Line Chart</span>'));b(a).append(b('<span id="'+g+'" class="tp-chart-icon tp-bchart"/><span class="tp-chart-label">Bar Chart</span>'));b(c).append(a)}},_renderChart:function(a){var b=this.chart;if(b){var d=this.options,g=this.currentChart,e=null,p=null;a?(e=a.type,p=a.axis):(g&&(e=g.type,p=g.axis),e&&p||(e=d.defaultChartType,p=d.defaultChartAxis));g.type==e&&g.axis==p||this._removeChart();a=this.element;d=a.find(".tp-empty");g=this.data;
null===g&&(g=JSON.parse(this.input.val()));g||(g={e:!0});this.data=g;if(g.e)this._removeChart(),a.find(".tp-empty").show();else switch(d.hide(),b.show(),p){case "totals":switch(e){case "barchart":this._renderBarChart(b,g.f,g.p);break;default:this._renderLineChart(b,g.f,g.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,b(window).off("resize.tp"))},_renderBarChart:function(a,c,d){var g=[];for(c=0;c<d.length;c++){var e=
d[c];g.push({start:(new Date(e.t[0])).getTime(),value:e.v[0]})}d=this.currentChart;if(d.chart){var p=d.container;var f=d.chart;p.datum([{key:"reportChart",values:g}]).transition().duration(500).call(f)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),p=d3.select(b(a).get(0)).append("svg").attr("class","nv"),f=nv.models.discreteBarChart().x(function(a){return a.start}).y(function(a){return a.value}).color(["silver"]).staggerLabels(!0).showValues(!0).forceY([0,
1]),f.tooltip.enabled(!1),a=this.options.numberFormatter,f.valueFormat(a),f.yAxis.tickFormat(a),f.xAxis.tickFormat(function(a){return(new Date(a)).toLocaleDateString()}),nv.addGraph(function(){p.datum([{key:"reportChart",values:g}]).transition().duration(500).call(f);b(window).off("resize.tp").on("resize.tp",function(a){f.update(a)});return f}),d.container=p,d.chart=f,d.type="barchart",d.axis="totals"},_renderLineChart:function(a,c,d){var g=[],e={},f=0,k=1==c.length,l;for(l=0;l<c.length;l++){var n=
c[l][0];e.hasOwnProperty(n)&&(f=e[n]+1);(e[n]=f)&&(n+=" ["+(f+1)+"]");var q={key:n,label:c[l][0],area:k},t=[];for(n=0;n<d.length;n++){var m=d[n];t.push({start:(new Date(m.t[0])).getTime(),value:m.v[l]})}q.values=t;g.push(q)}c=this.currentChart;if(c.chart){var h=c.container;var r=c.chart;h.datum(g).transition().duration(250).call(r)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),h=d3.select(b(a).get(0)).append("svg").attr("class","nv"),r=nv.models.lineChart().x(function(a){return a.start}).y(function(a){return a.value}).margin({right:50}).duration(250).showLegend(!0).useInteractiveGuideline(!0).forceY([0,
1]),r.yAxis.tickFormat(this.options.numberFormatter),r.xAxis.tickFormat(function(a){return(new Date(a)).toLocaleDateString()}),nv.addGraph(function(){h.datum(g).transition().duration(500).call(r);b(window).off("resize.tp").on("resize.tp",function(a){r.update(a)});return r}),c.container=h,c.chart=r,c.type="linechart",c.axis="totals"},reload:function(a,c,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof c&&(c=this._getFilters());var g=this,e=!1;b(this.element).find(".tp-throbber").show();if(a||c)e=
this._updateAjaxURL(a,c);e||d?(a=this.options.ajaxURL,c=b.ajaxS3,b.searchS3!==k&&(c=b.searchS3),c({url:a,type:"GET",dataType:"json",success:function(a){g.input.val(JSON.stringify(a));g.data=a;g.refresh()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})):g.refresh()},_getOptions:function(){var a="#"+b(this.element).attr("id"),c=b(a+"-time").val(),d=a=null,g=null;"custom"!=c&&(c=c.split("|"),3==c.length&&(a=c[0],d=c[1],g=c[2]));return{start:a,end:d,slots:g}},
_getFilters:function(){var a=b("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(c){return null}},_updateAjaxURL:function(a,c){var d=this.options.ajaxURL;if(!d)return!1;var g=d.split("?");if(1<g.length){var e=g[1];var f=e.split("&")}else e="",f=[];var k=[];d=!1;if(a)for(var l in a)e=a[l],e=l+"="+e,d||-1!=b.inArray(e,f)||(d=!0),k.push(e);l={};var n={},q;if(c){var t=function(a){var b,c,d=[];["contains","anyof","belongs","eq"].forEach(function(e){b=
new RegExp("__"+e+"$","g");a.match(b)?c=b:d.push(e)});c&&d.forEach(function(b){n[a.replace(c,"__"+b)]=!0})};e=0;for(q=c.length;e<q;e++){var m=c[e];var h=m[0];m=m[1];t(h);null===m?l[h]||(n[h]=!0):(n[h]&&(n[h]=!1),m=h+"="+encodeURIComponent(m),l[h]?l[h].push(m):l[h]=[m])}}e=0;for(q=f.length;e<q;e++)m=f[e].split("="),1<m.length&&(h=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),n[h]?d=!0:l[h]?d||-1!=b.inArray(h+"="+m,l[h])||(d=!0):a&&a.hasOwnProperty(h)||k.push(f[e]));for(h in l)for(e=0,q=l[h].length;e<
q;e++)d||-1!=b.inArray(l[h][e],f)||(d=!0),k.push(l[h][e]);a=k.join("&");c=g[0];a&&(c=c+"?"+a);this.options.ajaxURL=c;return d},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,c="#"+this.widget_id;b(c+"-options legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-filters legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-time").on("change.autosubmit",function(){b(c+
"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var d=this.options.autoSubmit;b(c+"-tp-form").on("optionChanged",function(){var c=b(this);if(!c.data("noAutoSubmit")){var e=c.data("autoSubmitTimeout");e&&clearTimeout(e);e=setTimeout(function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)},d);c.data("autoSubmitTimeout",e)}})}else b(c+"-tp-form input.tp-submit").on("click.timeplot",function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)});b(c+"-lchart-totals").click(function(){a._renderChart({type:"linechart",
axis:"totals"})});b(c+"-bchart-totals").click(function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;b(window).off("resize.timeplot");b(a+"-tp-form").off("optionChanged");b(a+"-tp-form input.tp-submit").off("click.timeplot");b(a+"-time").unbind("change.autosubmit");b(a+"-options legend").unbind("click");b(a+"-filters legend").unbind("click");b(a+"-lchart-totals,"+a+"-bchart-totals").unbind("click")}})})(jQuery);
