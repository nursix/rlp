/*
 2015-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,p,q){c instanceof String&&(c=String(c));for(var f=c.length,l=0;l<f;l++){var m=c[l];if(p.call(q,m,l,c))return{i:l,v:m}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,p,q){if(c==Array.prototype||c==Object.prototype)return c;c[p]=q.value;return c};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,c,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var p=0;p<c.length;++p){var q=c[p];if(q&&q.Math==Math)return q}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(c,p){var q=$jscomp.propertyToPolyfillSymbol[p];if(null==q)return c[p];q=c[q];return void 0!==q?q:c[p]};
$jscomp.polyfill=function(c,p,q,f){p&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(c,p,q,f):$jscomp.polyfillUnisolated(c,p,q,f))};$jscomp.polyfillUnisolated=function(c,p,q,f){q=$jscomp.global;c=c.split(".");for(f=0;f<c.length-1;f++){var l=c[f];if(!(l in q))return;q=q[l]}c=c[c.length-1];f=q[c];p=p(f);p!=f&&null!=p&&$jscomp.defineProperty(q,c,{configurable:!0,writable:!0,value:p})};
$jscomp.polyfillIsolated=function(c,p,q,f){var l=c.split(".");c=1===l.length;f=l[0];f=!c&&f in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var m=0;m<l.length-1;m++){var b=l[m];if(!(b in f))return;f=f[b]}l=l[l.length-1];q=$jscomp.IS_SYMBOL_NATIVE&&"es6"===q?f[l]:null;p=p(q);null!=p&&(c?$jscomp.defineProperty($jscomp.polyfills,l,{configurable:!0,writable:!0,value:p}):p!==q&&($jscomp.propertyToPolyfillSymbol[l]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(l):$jscomp.POLYFILL_PREFIX+l,l=
$jscomp.propertyToPolyfillSymbol[l],$jscomp.defineProperty(f,l,{configurable:!0,writable:!0,value:p})))};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(p,q){return $jscomp.findInternal(this,p,q).v}},"es6","es3");
(function(c,p){var q=0,f={},l={},m={};c.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=q;q+=1;this.eventNamespace=".locationselector"},_init:function(){var b=c(this.element),a=this.options,d=b.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=b;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var b=this._deserialize();this._renderWidget();var a="#"+this.fieldname,d=this.options;c(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=c(a+"_L0__row");if(e.length){var h=[];for(u in f){var k=f[u];0===k.l&&(k.i=u,h.push(k))}h.sort(function(x,r){return x.n.localeCompare(r.n)});for(var g=c(a+"_L0"),n=0,t=h.length;n<t;n++){k=h[n];var u=k.i;k='<option value="'+
u+'">'+k.n+"</option>";g.append(k)}e.removeClass("hide").show();e=c(a+"_L0__row1");e.length&&e.removeClass("hide").show()}e=b.L0;h=b.L1;g=b.L2;n=b.L3;t=b.L4;k=b.L5;e&&this._lxSelect(0,e,!0);(h||g)&&this._lxSelect(1,h||g,!0);(g||n)&&this._lxSelect(2,g||n,!0);(n||t)&&this._lxSelect(3,n||t,!0);(t||k)&&this._lxSelect(4,t||k,!0);k&&this._lxSelect(5,k,!0);this.lx=[e,h,g,n,t,k].join("|");c(a+"_address").val(b.address);c(a+"_address__row").removeClass("hide").show();c(a+"_address__row1").removeClass("hide").show();
c(a+"_postcode").val(b.postcode);c(a+"_postcode__row").removeClass("hide").show();c(a+"_postcode__row1").removeClass("hide").show();c(a+"_lat").val(b.lat).latloninput({type:"lat",mode:d.latlonMode});c(a+"_lat__row").removeClass("hide").show();c(a+"_lat__row1").removeClass("hide").show();c(a+"_lon").val(b.lon).latloninput({type:"lon",mode:d.latlonMode});c(a+"_lon__row").removeClass("hide").show();c(a+"_lon__row1").removeClass("hide").show();e=c(a+"_map_icon__row").removeClass("hide").show();b.lat||
b.lon||b.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&e.is(":visible")&&"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var b=this.fieldname,a="#"+b,d=this.options.reverseLx,e=c(a+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var h=c(a+"__row"),k=this.input.next(".error_wrapper"),
g=c(a+"_map_icon__row"),n=c(a+"_L0__row"),t=c(a+"_postcode__row");if(h.is(".control-group, .form-row")){b=c(a+"_L1__row");var u=c(a+"_L2__row"),x=c(a+"_L3__row"),r=c(a+"_L4__row"),v=c(a+"_L5__row"),w=c(a+"_address__row"),z=c(a+"_lat__row"),A=c(a+"_lon__row");a=c(a+"_latlon_toggle__row");d?h.hide().after(e).after(g).after(a).after(A).after(z).after(n).after(b).after(u).after(x).after(r).after(v).after(t).after(w).after(k):h.hide().after(e).after(g).after(a).after(A).after(z).after(t).after(w).after(v).after(r).after(x).after(u).after(b).after(n).after(k)}else h.parent().is(".inline-form")?
h.show():(c(a+"__row1").hide(),h.hide().after(k),g.detach(),h.siblings('[id^="'+b+'"][id$="__row"]').last().after(e).after(g));if(k.length)k.one("click"+this.eventNamespace,function(){var y=c(this);y.fadeOut("slow",function(){y.remove()})})},_lxSelectFinal:function(b){b?this._serialize():this._collectData();this._zoomMap()},_lxSelect:function(b,a,d){var e="#"+this.fieldname,h=this.options,k=c(e+"_L"+b),g;a?(k.val(a).trigger("change","implicit"),k.hasClass("multiselect")&&k.multiselect("instance")&&
k.multiselect("refresh")):a=parseInt(k.val(),10);if(0===b){var n=this._readLabels(a),t=l.d,u=["1","2","3","4","5"],x,r,v;n.then(function(I){for(v=0;5>v;v++)g=u[v],x=I[g]||t[g],w=e+"_L"+g,k=c(w),r=h.showLabels?k.hasClass("required")?"<div>"+x+':<span class="req"> *</span></div>':x+":":"",c(w+"__row label").html(r),c(w+"__row1 label").html(r),c(w+' option[value=""]').html(i18n.select+" "+x),k.hasClass("multiselect")&&k.multiselect("instance")&&k.multiselect("refresh")})}n=h.hideLx;for(g=b+1;6>g;g++){var w=
e+"_L"+g;n?(c(w+"__row").hide(),c(w+"__row1").hide()):c(w+" option").remove('[value != ""]');c(w).val("").trigger("change","implicit")}if(a){var z=!1,A=b+1,y=c(e+"_L"+A+"__row");y.length||(z=!0,A++,y=c(e+"_L"+A+"__row"));if(y.length){var B;n=!1;var E=this;if(c(e+"_L"+b+' option[value="'+a+'"]').hasClass("missing")){var C=f[a];C.i=a;var F=[C]}else for(B in F=[],n=!0,f)if(f[B].f==a){n=!1;break}this._readHierarchy(n,a,A,z).then(function(){if(0==F.length)for(B in f)C=f[B],C.f==a&&(C.i=B,F.push(C));var I=
F.length;if(I){F.sort(function(J,K){return J.n.localeCompare(K.n)});var G=e+"_L"+A;var D=c(G),H=c(G+' option[value=""]').html();c(G+" option").remove('[value != ""]');B=null;for(v=0;v<I;v++)C=F[v],B=C.i,G=a==B?' selected="selected"':"",z=C.l==A?"":' class="missing"',G='<option value="'+B+'"'+G+z+">"+C.n+"</option>",D.append(G);y.removeClass("hide").show();c(e+"_L"+A+"__row1").removeClass("hide").show();D.hasClass("multiselect")&&(H={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:H,
multiple:!1},D.hasClass("search")?(D.multiselect(H).multiselectfilter({label:"",placeholder:i18n.search}),c(".ui-multiselect-header").show()):(H.header=!1,D.multiselect(H)));D=E.data["L"+A];H=F.map(function(J){return J.i});D&&-1!=H.indexOf(""+D)?E._lxSelect(A,D,d):1==I&&B&&E._lxSelect(A,B,d)}E._lxSelectFinal(d)})}else this.useGeocoder&&!d&&this._geocodeDecision(),this._lxSelectFinal(d)}else this._lxSelectFinal(d)},_collectData:function(b){var a=this.data,d="#"+this.fieldname,e=this._lookupParent(),
h=c(d+"_address").val(),k=c(d+"_postcode").val();a.address=h;a.postcode=k;if(a.specific)a.id=a.specific,a.parent=e;else{var g=a.lat,n=a.lon,t=a.wkt;h||k||g||n||t?(a.id=null,a.parent=e):(a.id=e,a.parent=null)}this._serialize();c(d+"_lat").val(a.lat).trigger("setvalue");c(d+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",b&&"user"||"implicit")},_collectLx:function(){var b=this.data,a="#"+this.fieldname,d;
for(d=0;6>d;d++){var e=c(a+"_L"+d);e.length&&(e=e.val(),b["L"+d]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var b=this.data,a=!1;b.specific||b.address||b.postcode||b.lat||b.lon||b.wkt?a=!0:[b.L0,b.L1,b.L2,b.L3,b.L4,b.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var b=this.data,a,d=5;-1<d;d--)if(a=b["L"+d])return a;return(b=f.d)?b.i:null},_readLabels:function(b){b||(b="d");var a=c.Deferred(),d=l[b];if(d==p){var e=S3.Ap.concat("/gis/hdata/"+
b);c.ajaxS3({url:e,dataType:"json",success:function(h){d={};try{for(var k in h)d[k]=h[k];l[b]=d}catch(g){}a.resolve(d)},error:function(h,k,g){(h="UNAUTHORIZED"==g?i18n.gis_requires_login:h.responseText)&&s3_debug(h);a.reject()}})}else a.resolve(d);return a.promise()},_readHierarchy:function(b,a,d,e){var h=""+a+";"+d+";"+e,k=m[h];if(k!==p)return k;var g=c.Deferred();if(b){b="#"+this.fieldname;var n=c(b+"_L"+d),t=!1;n.hide();if(n.hasClass("multiselect")){t=!0;var u=c(b+"_L"+d+"__row button").hide()}var x=
c(b+"_L"+d+"__throbber").removeClass("hide").show();a=e?S3.Ap.concat("/gis/ldata/"+a+"/"+d):S3.Ap.concat("/gis/ldata/"+a);c.ajaxS3({url:a,dataType:"json",success:function(r){for(var v in r)f[v]=r[v];x.hide();t?u.removeClass("hide").show():n.removeClass("hide").show();g.resolve()},error:function(r,v,w){if(r="UNAUTHORIZED"==w?i18n.gis_requires_login:r.responseText)s3_debug(r),S3.showAlert(r,"error");x.hide();t?u.removeClass("hide").show():n.removeClass("hide").show();g.reject()}})}else g.resolve();
return k=m[h]=g.promise()},_geocodeDecision:function(){var b="#"+this.fieldname,a=this.data;this._collectData();if(a.address){a=["1","2","3","4","5"];for(var d=0,e;5>d;d++)if(e=c(b+"_L"+a[d]),e.length&&!e.val()&&1<e[0].options.length)return;c(b+"_geocode .geocode_success,"+b+"_geocode .geocode_fail").hide();var h=this;a=this.eventNamespace;this.input.data("manually_geocoded")?c(b+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+a,function(){c(this).hide();h._geocode()}):this._geocode()}},
_geocode:function(){var b=this.fieldname,a=this,d="#"+b,e=c(d+"_geocode .geocode_fail").hide(),h=c(d+"_geocode .geocode_success").hide(),k=c(d+"_geocode .throbber").removeClass("hide").show(),g=this.data;d={address:g.address};for(var n="postcode L0 L1 L2 L3 L4 L5".split(" "),t=0,u,x;7>t;t++)u=n[t],(x=g[u])&&(d[u]=x);n=S3.Ap.concat("/gis/geocode");c.ajaxS3({url:n,type:"POST",data:d,dataType:"json",success:function(r){var v=r.lat,w=r.lon;if(v||w){g.lat=parseFloat(v);g.lon=parseFloat(w);a._collectData();
v=S3.gis;if(v.maps&&(w=v.maps["location_selector_"+b])){r=w.s3.draftLayer;r.removeAllFeatures();var z=new OpenLayers.Geometry.Point(g.lon,g.lat);z.transform(v.proj4326,w.getProjectionObject());v=new OpenLayers.Feature.Vector(z);r.addFeatures([v]);a._zoomMap()}k.hide();h.html(i18n.address_mapped).removeClass("hide").show()}else k.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(r)},error:function(r,v,w){r="UNAUTHORIZED"==w?i18n.gis_requires_login:r.responseText;k.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(r)}})},_geocodeReverse:function(){var b=this,a="#"+this.fieldname,d=c(a+"_geocode .geocode_fail").hide(),e=c(a+"_geocode .geocode_success").hide(),h=c(a+"_geocode .throbber").removeClass("hide").show();a=this.data;a={lat:a.lat,lon:a.lon};var k=S3.Ap.concat("/gis/geocode_r");c.ajaxS3({async:!1,url:k,type:"POST",data:a,dataType:"json",success:function(g){g.L0?(b.useGeocoder=!1,b._lxSelect(0,g.L0),g.L1&&b._lxSelect(1,g.L1),g.L2&&b._lxSelect(2,g.L2),g.L3&&b._lxSelect(3,g.L3),g.L4&&b._lxSelect(4,
g.L4),g.L5&&b._lxSelect(5,g.L5),b.useGeocoder=!0,h.hide(),e.html(i18n.location_found).removeClass("hide").show()):(h.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(g,n,t){g="UNAUTHORIZED"==t?i18n.gis_requires_login:g.responseText;h.hide();d.html(i18n.location_not_found).removeClass("hide").show();s3_debug(g)}})},_latlonInput:function(){var b=this.fieldname,a=this.data,d="#"+b,e=c(d+"_lat").val();d=c(d+"_lon").val();e||d?(e=e?parseFloat(e):0,d=d?parseFloat(d):0,
a.lat=e,a.lon=d,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(b=e.maps["location_selector_"+b])&&(d=b.s3.draftLayer,d.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(e.proj4326,b.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.addFeatures([a]),b.s3.lastDraftFeature=a),this._zoomMap())},_showMap:function(b){var a=this.fieldname,
d=this.eventNamespace,e=this,h="#"+a;c(h+"_map_icon").unbind(d).bind("click"+d,function(){e._hideMap()});c(h+"_map_icon span").html(i18n.hide_map);d=c(h+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&b&&c("html,body").animate({scrollTop:d.offset().top},250);var k=this.input;c.when(this._jsLoaded()).then(function(){var g=S3.gis,n="location_selector_"+a;var t=g.maps[n]?g.maps[n]:g.show_map(n);e._zoomMap();var u=e.data;n=u.lat;var x=u.lon,r=u.wkt;if(n||x||r)t.s3.draftLayer.removeAllFeatures(),
r!=p&&r?(n={internalProjection:t.getProjectionObject(),externalProjection:g.proj4326},n=(new OpenLayers.Format.WKT(n)).read(r)):(n=new OpenLayers.Geometry.Point(parseFloat(x),parseFloat(n)),n.transform(g.proj4326,t.getProjectionObject()),n=new OpenLayers.Feature.Vector(n)),t.s3.draftLayer.addFeatures([n]),t.s3.lastDraftFeature=n;n=t.controls;x=0;for(var v=n.length;x<v;x++)if("OpenLayers.Control.DrawFeature"==n[x].CLASS_NAME){var w=n[x];break}w&&(t.s3.pointPlaced=function(z){c(h+"_geocode .geocode_fail").hide();
c(h+"_geocode .geocode_success").hide();var A=z.geometry;if("OpenLayers.Geometry.Point"==A.CLASS_NAME)z=A.getBounds().getCenterLonLat(),z.transform(t.getProjectionObject(),g.proj4326),u.wkt=null,u.lat=z.lat,u.lon=z.lon,!u.address&&e.useGeocoder&&e._geocodeReverse();else{A={internalProjection:t.getProjectionObject(),externalProjection:g.proj4326};u.radius=null;var y=new OpenLayers.Geometry.LinearRing(z.geometry.components[0].components);y=new OpenLayers.Geometry.Polygon([y]);if(1E3==y.getVertices().length){var B=
(new OpenLayers.Feature.Vector(y,null)).geometry.getBounds();y=B.right;var E=(B.bottom+B.top)/2;B=new OpenLayers.Geometry.Point((B.left+y)/2,E);y=new OpenLayers.Geometry.Point(y,E);y=new OpenLayers.Geometry.LineString([B,y]);y=parseFloat(y.getLength());u.radius=y}r=(new OpenLayers.Format.WKT(A)).write(z);u.wkt=r;u.lat=null;u.lon=null}k.data("manually_geocoded",!0);e._collectData(!0);e._removeErrors();"sub_"==a.substring(0,4)&&k.parent().find("div.map_wrapper").trigger("change")})},function(g){s3_debug(g)},
function(g){s3_debug(g)})},_hideMap:function(){var b=this.fieldname,a=this.eventNamespace,d="#"+b,e=this;c(d+"_map_icon").unbind(a).bind("click"+a,function(k){e._showMap(k)});c(d+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var h=i18n.show_map_view;else if(h=i18n.show_map_add,S3.gis.maps&&(b=S3.gis.maps["location_selector_"+b]))b.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();c(d+"_map_icon span").html(h)},
_zoomMap:function(b){var a=this.fieldname,d=S3.gis;if(d.maps&&(a=d.maps["location_selector_"+a])){var e=this.data;d=e.lat;var h=e.lon;e=e.wkt;if(d&&h)d=OpenLayers.Bounds.fromArray([h,d,h,d]);else if(e)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(e))).geometry.getBounds();else{b||(b=this._lookupParent()||"d");d=f[b].b;if(!d||!d.length)for(h=f[b].f,b=4;h&&b&&(b--,h=f[h],!(d=h.b)&&0!==h.l);)h=h.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&S3.gis.zoomBounds(a,d,this.options.minBBOX)}},_validate:function(){var b=
this.fieldname;this._removeErrors();b="#"+b;var a=this.data,d=this.options.featureRequired;if(d){var e=!1;switch(d){case "latlon":e=a.lat||a.lon;break;case "wkt":e=a.wkt;break;default:e=a.lat||a.lon||a.wkt}if(!e)return S3.fieldError(b+"_map_icon",i18n.map_feature_required),!1}var h=a.id;d="address L5 L4 L3 L2 L1 L0".split(" ");e=function(n){return n.hasClass("multiselect")?n.next("button.ui-multiselect").is(":visible"):n.is(":visible")};if(h){if(!f[h])return!0;var k=f[h].l;for(a=0;a<6-k;a++){h=b+
"_"+d[a];var g=c(h);if(g.length&&g.hasClass("required")&&e(g))return S3.fieldError(h,i18n.enter_value),!1}}else{if(a.lat||a.lon||a.wkt||a.address||a.postcode)return!0;for(a=0;7>a;a++)if(h=b+"_"+d[a],g=c(h),g.length&&g.hasClass("required")&&e(g))return S3.fieldError(h,i18n.enter_value),!1}return!0},_serialize:function(){var b=JSON.stringify(this.data);this.input.val(b);return b},_deserialize:function(){var b=this.input.val();return this.data=JSON.parse(b)},_storeHierarchyData:function(b,a){var d;if(a)for(d in a)f[d]=
a[d];if(b)for(d in b)l[d]=b[d]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=p?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},_removeErrors:function(b){b||(b="#"+this.fieldname,b=b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon");c(b).siblings(".error").remove()},_bindEvents:function(){var b=this.fieldname,a=this.eventNamespace,d=this,
e="#"+b;c(e+"_L0").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(0)});c(e+"_L1").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(1)});c(e+"_L2").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(2)});c(e+"_L3").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(3)});c(e+"_L4").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(4)});c(e+"_L5").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(5)});c(e+"_address,"+e+"_postcode").bind("change"+
a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});c(e+"_lat,"+e+"_lon").bind("change"+a,function(){d._latlonInput()});c(e+"_latlon_toggle").bind("click"+a,function(){var k=c(this).data("mode")||d.options.latlonMode;if("dms"==k){k="decimal";var g=i18n.latlon_mode.dms}else k="dms",g=i18n.latlon_mode.decimal;c(e+"_lat").latloninput("option",{mode:k});c(e+"_lon").latloninput("option",{mode:k});c(this).html(g).data("mode",k)});if("sub_"==b.substring(0,4))this.input.closest(".inline-form").bind("validate"+
a+this.id,function(k){d._validate()||k.preventDefault()});else{var h=this.input.closest("form");h.bind("submit"+a+this.id,function(k){k.preventDefault();d._validate()&&h.unbind(a+d.id).submit()})}return!0},_unbindEvents:function(){var b="#"+this.fieldname,a=this.eventNamespace;c(b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon,"+b+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(c,p){var q=0;c.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=q;q+=1;this.eventNamespace=".latloninput"},_init:function(){c(this.element).hide();this.refresh()},_destroy:function(){c(this.element).show();c.Widget.prototype.destroy.call(this)},_setOption:function(f,l){this._super(f,l);"mode"==f&&this.refresh()},refresh:function(){this._unbindEvents();var f=c(this.element),l=this.options;this.defaultValue=f.val();
if(!this.input){var m=c("<div>").hide().insertAfter(f),b=c('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var a=l.labels,d=c('<input type="text" class="integer dms-input" size="5">'),e=c('<span class="dms-label">'+a.deg+"</span>"),h=c('<input type="text" class="integer dms-input" size="5">'),k=c('<span class="dms-label">'+a.min+"</span>"),g=c('<input type="text" class="double dms-input" size="8">');a=c('<span class="dms-label">'+a.sec+"</span>");this.degInput=d;this.minInput=
h;this.secInput=g;this.dmsInput=d=c("<span>").append(d).append(e).append(h).append(k).append(g).append(a).hide();this.input=m.append(b).append(d).show()}this._removeErrors();"dms"==l.mode?(f=this._getDMS(),this.degInput.val(f.d),this.minInput.val(f.m),this.secInput.val(f.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(f.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var f=c(this.element).val();if(isNaN(parseFloat(f))||!isFinite(f))return{d:"",
m:"",s:""};var l=Math.abs(f);l=60*(l-parseInt(l,10));if(1E-10>Math.abs(l-Math.round(l))){l=Math.round(l);var m=0}else m=60*(l-parseInt(l,10)),1E-10>Math.abs(m-Math.round(m))&&(m=Math.round(m));return{d:parseInt(f,10),m:parseInt(l,10),s:m}},_showError:function(f,l){"all"==f?this.input.find("input").addClass("invalidinput"):f&&f.addClass("invalidinput");l&&this.input.append('<div class="error">'+l+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var f=90;var l=i18n.latlon_error.lat}else f=180,l=i18n.latlon_error.lon;var m=this.degInput.val(),b=this.minInput.val(),a=this.secInput.val(),d=[];if(""===m&&""===b&&""===a)return"";m=parseInt(m,10)||0;b=parseInt(b,10)||0;a=parseFloat(a)||0;60<=Math.abs(b)&&(this._showError(this.minInput),d.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),d.push(i18n.latlon_error.sec));b=Math.abs(m)+b/60+a/3600;
if(!d.length&&b>f||m>f)this._showError("all"),d.push(l);return d.length?(this._showError(null,d.join(", ")),null):(0>m?-1:1)*b},_validateDecimal:function(){this._removeErrors();var f=this.options.type,l=i18n.latlon_error.format;if("lat"==f){var m=90;var b=i18n.latlon_error.lat}else m=180,b=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,f);null===a?this._showError(this.decimalInput,l):Math.abs(a)>m&&(this._showError(this.decimalInput,b),a=null);return a},_parse:function(f,
l){var m="lat"==l?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,d=l=0,e=0;if(f.match(b))return a=f.replace(b,"$1|$2|$3").split("|"),(f=a[0]||a[2])&&(f=m[f]),l=parseFloat(a[1]),f&&Math.abs(l)!=l&&(f=null),f&&(l*=f),l;if(f.match(a)){a=f.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(f=a[0]||a[7])&&
(f=m[f]);m=[];b=[];var h,k;for(k=1;6>k;k+=2){var g=a[k];(h=a[k+1])?(m.push(parseFloat(g)||0),b.push(h)):g&&(m.push(parseFloat(g)),b.push(null))}if(a=m.length){for(k=1;k<a;k++)m[k]=Math.abs(m[k]);g=m[0];Math.abs(g)!=g&&(f=1);if(1==a)h=b[0],'"'==h?e=m[0]:"'"==h?d=m[0]:h&&"\u00b0"!=h||(l=m[0]);else if(2==a)if(a=b[0],b=b[1],"\u00b0"==a)l=m[0],'"'==b?e=m[1]:"'"!=b&&b||(d=m[1]);else if(a){if("'"!=a||b&&'"'!=b)return null;d=m[0];e=m[1]}else'"'==b?(d=m[0],e=m[1]):"'"!=b&&b||(l=m[0],d=m[1]);else{if(b[0]&&
"\u00b0"!=b[0]||b[1]&&"'"!=b[1]||b[2]&&'"'!=b[2])return null;l=m[0];d=m[1];e=m[2]}l=l+d/60+e/3600;f&&(l*=f);return l}}return null},_bindEvents:function(){var f=this,l=this.eventNamespace;this.dmsInput.find("input").bind("change"+l,function(){var m=f._validateDMS();null!==m?c(f.element).val(m).change():c(f.element).val(f.defaultValue).change()});this.decimalInput.bind("change"+l,function(){var m=f._validateDecimal();null!==m?(c(f.element).val(m).change(),f.decimalInput.val(m)):c(f.element).val(f.defaultValue).change()});
c(this.element).bind("setvalue"+l,function(){f.refresh()});return!0},_unbindEvents:function(){var f=this.eventNamespace;this.input&&this.input.find("input").unbind(f);c(this.element).unbind(f);return!0}})})(jQuery);
